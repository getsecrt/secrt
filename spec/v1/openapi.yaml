openapi: 3.1.0
info:
  title: secrt.ca API
  version: "1.0"
  description: |
    One-time secret sharing API. The server stores **ciphertext envelopes only**;
    decryption keys must never be sent to or stored on the server.

    ## Authentication

    v2 wire API keys are accepted via either header:

    - `X-API-Key: ak2_<prefix>.<auth_b64>`
    - `Authorization: Bearer ak2_<prefix>.<auth_b64>`

    Session-authenticated endpoints use passkey session bearer tokens:

    - `Authorization: Bearer uss_<sid>.<secret>`

    `GET/POST /api/v1/secrets`, `GET /api/v1/secrets/check`, and
    `POST /api/v1/secrets/{id}/burn` accept either session or API key auth.
    Runtime auth order:
    - `/api/v1/secrets` and `/api/v1/secrets/check`: session first, API key fallback
    - `/api/v1/secrets/{id}/burn`: API key first, session fallback

    v1 passkey auth currently uses challenge-id bearer semantics in `/finish`
    endpoints (valid, unexpired `challenge_id` + credential linkage). WebAuthn
    cryptographic assertion verification is out of scope for v1.

    ## Policy Tiers

    | Limit                  | Public (anonymous)    | Authenticated (session/API key) |
    |------------------------|-----------------------|-------------------------|
    | Max envelope size      | 256 KB (configurable) | 1 MB (configurable)     |
    | Max active secrets     | 10 (configurable)     | 1000 (configurable)     |
    | Max active total bytes | 2 MB (configurable)   | 20 MB (configurable)    |

  contact:
    name: secrt.ca
    url: https://secrt.ca
  license:
    name: MIT

servers:
  - url: https://secrt.ca
    description: Production
  - url: http://localhost:8080
    description: Local development

paths:
  /healthz:
    get:
      operationId: healthCheck
      summary: Health check
      tags: [health]
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /api/v1/info:
    get:
      operationId: getServerInfo
      summary: Server info and limits
      description: |
        Returns server defaults and per-tier limits. Authentication is optional;
        if a valid API key is provided, `authenticated` is `true`. Invalid keys
        are not an error â€” `authenticated` will be `false`.

        Both tiers are always returned regardless of authentication status.
        Rate-limited via the claim limiter (1 rps, burst 10).
      tags: [info]
      security:
        - {}
        - apiKey: []
        - bearerAuth: []
      responses:
        "200":
          description: Server info and limits
          headers:
            Cache-Control:
              schema:
                type: string
                example: "public, max-age=300"
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InfoResponse"
        "429":
          $ref: "#/components/responses/RateLimited"

  /api/v1/public/secrets:
    post:
      operationId: createPublicSecret
      summary: Create a secret (anonymous)
      description: |
        Store a client-encrypted envelope for one-time retrieval.
        No API key required. Subject to public rate limits and quota tier.

        Ownership is tracked server-side by client IP for quota enforcement.
      tags: [secrets]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateSecretRequest"
            example:
              envelope:
                v: 1
                suite: "v1-argon2id-hkdf-aes256gcm-sealed-payload"
                enc:
                  alg: "A256GCM"
                  nonce: "<base64url, 12 bytes>"
                  ciphertext: "<base64url, ciphertext + 16-byte GCM tag>"
                kdf:
                  name: "none"
                hkdf:
                  hash: "SHA-256"
                  salt: "<base64url, 32 bytes>"
                  enc_info: "secrt:v1:enc:sealed-payload"
                  claim_info: "secrt:v1:claim:sealed-payload"
                  length: 32
              claim_hash: "dGhpcyBpcyBhIGJhc2U2NHVybCBoYXNo"
              ttl_seconds: 86400
      responses:
        "201":
          description: Secret Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateSecretResponse"
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
        "400":
          $ref: "#/components/responses/BadRequest"
        "413":
          $ref: "#/components/responses/StorageQuotaExceeded"
        "429":
          $ref: "#/components/responses/RateLimited"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/secrets/check:
    get:
      operationId: checkSecrets
      summary: Check owned secret set checksum
      description: |
        Lightweight change-detection endpoint for high-frequency dashboard sync.
        Returns `count` and an opaque `checksum` for active secrets visible to
        the current auth scope.

        Uses the same auth scope as `GET /api/v1/secrets`:
        - session auth: `user:<id>` + unrevoked owned API key owner keys
        - API key auth: only `apikey:<prefix>` for that key
      tags: [secrets]
      security:
        - sessionBearer: []
        - apiKey: []
        - bearerAuth: []
      responses:
        "200":
          description: Count + checksum for owned active secrets
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SecretsCheckResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/secrets:
    get:
      operationId: listSecrets
      summary: List owned secrets (metadata)
      description: |
        Returns metadata for active secrets visible to the current auth scope.
        Supports session and API key auth.

        Query behavior:
        - `limit`: default `50`, clamped to `1..20000`
        - `offset`: default `0`, clamped to `>=0`
      tags: [secrets]
      security:
        - sessionBearer: []
        - apiKey: []
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            format: int64
            minimum: 1
            maximum: 20000
            default: 50
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            format: int64
            minimum: 0
            default: 0
      responses:
        "200":
          description: Owned secret metadata list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListSecretsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"
    post:
      operationId: createAuthedSecret
      summary: Create a secret (authenticated)
      description: |
        Store a client-encrypted envelope for one-time retrieval.
        Requires session or API key auth and uses authenticated limits.

        Runtime auth resolution order is session first, then API key fallback.
      tags: [secrets]
      security:
        - sessionBearer: []
        - apiKey: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateSecretRequest"
      responses:
        "201":
          description: Secret Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateSecretResponse"
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "413":
          $ref: "#/components/responses/StorageQuotaExceeded"
        "429":
          $ref: "#/components/responses/RateLimited"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/secrets/{id}/claim:
    post:
      operationId: claimSecret
      summary: Claim a secret (one-time retrieval)
      description: |
        Atomically returns the envelope and deletes the secret.
        The claim token is hashed server-side and compared to the stored claim hash.

        No API key required; possession of the claim token is sufficient.

        Returns 404 for expired, already-claimed, unknown, or wrong-token secrets
        to avoid leaking secret existence.
      tags: [secrets]
      parameters:
        - $ref: "#/components/parameters/secretId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ClaimSecretRequest"
            example:
              claim: "dGhpcyBpcyBhIGNsYWltIHRva2Vu"
      responses:
        "200":
          description: Secret claimed and deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClaimSecretResponse"
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/RateLimited"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/secrets/{id}/burn:
    post:
      operationId: burnSecret
      summary: Burn a secret (delete without claiming)
      description: |
        Deletes a secret without returning its envelope.
        Accepts session or API key auth.

        API key auth burns only `owner_key == "apikey:<prefix>"`.
        Session auth checks `user:<id>` plus unrevoked owned API key owner keys.
        Returns 404 for unknown secrets or owner mismatches.
      tags: [secrets]
      security:
        - sessionBearer: []
        - apiKey: []
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/secretId"
      responses:
        "200":
          description: Secret burned
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BurnResponse"
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/auth/passkeys/register/start:
    post:
      operationId: passkeyRegisterStart
      summary: Start passkey registration
      description: |
        Issues a random challenge_id and opaque challenge value.
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PasskeyRegisterStartRequest"
      responses:
        "200":
          description: Registration challenge issued
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PasskeyStartResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/auth/passkeys/register/finish:
    post:
      operationId: passkeyRegisterFinish
      summary: Complete passkey registration and create session
      description: |
        v1 consumes a valid, unexpired challenge_id and does not perform
        cryptographic WebAuthn assertion verification.
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PasskeyRegisterFinishRequest"
      responses:
        "200":
          description: Session created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthFinishResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/auth/passkeys/login/start:
    post:
      operationId: passkeyLoginStart
      summary: Start passkey login
      description: |
        Issues a random challenge_id and opaque challenge value.
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PasskeyLoginStartRequest"
      responses:
        "200":
          description: Login challenge issued
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PasskeyStartResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/auth/passkeys/login/finish:
    post:
      operationId: passkeyLoginFinish
      summary: Complete passkey login and create session
      description: |
        v1 consumes a valid, unexpired challenge_id and does not perform
        cryptographic WebAuthn assertion verification.
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PasskeyLoginFinishRequest"
      responses:
        "200":
          description: Session created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthFinishResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/auth/session:
    get:
      operationId: authSession
      summary: Get current passkey session status
      tags: [auth]
      security:
        - {}
        - sessionBearer: []
      responses:
        "200":
          description: Session status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionResponse"

  /api/v1/auth/logout:
    post:
      operationId: authLogout
      summary: Revoke current passkey session
      tags: [auth]
      security:
        - sessionBearer: []
      responses:
        "200":
          description: Logged out
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BurnResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/auth/device/challenge:
    get:
      operationId: deviceChallenge
      summary: Get device challenge details
      description: |
        Returns challenge details for a pending device authorization, including
        the CLI's ECDH public key if provided. Used by the browser to set up
        AMK transfer during device approval.
      tags: [auth]
      security:
        - sessionBearer: []
      parameters:
        - name: user_code
          in: query
          required: true
          schema:
            type: string
          description: User code displayed in the CLI terminal (format XXXX-XXXX)
      responses:
        "200":
          description: Challenge details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeviceChallengeResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/auth/device/start:
    post:
      operationId: deviceStart
      summary: Start device authorization flow
      description: |
        Initiates a device authorization flow for CLI login. The CLI pre-generates
        key material and sends only the derived auth_token. The server issues a
        device_code (for polling) and a human-readable user_code (for browser approval).
        Challenge expires after 10 minutes.
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DeviceStartRequest"
      responses:
        "200":
          description: Device authorization started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeviceStartResponse"
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/RateLimited"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/auth/device/poll:
    post:
      operationId: devicePoll
      summary: Poll device authorization status
      description: |
        Checks the status of a pending device authorization. Returns
        `authorization_pending` while waiting for browser approval, or
        `complete` with the API key prefix once approved. The challenge
        is consumed on successful completion.
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DevicePollRequest"
      responses:
        "200":
          description: Authorization status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DevicePollResponse"
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/RateLimited"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/auth/device/approve:
    post:
      operationId: deviceApprove
      summary: Approve device authorization (session required)
      description: |
        Approves a pending device authorization by user_code. Requires an
        authenticated passkey session. Creates an API key linked to the
        session user and marks the challenge as approved.
      tags: [auth]
      security:
        - sessionBearer: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DeviceApproveRequest"
      responses:
        "200":
          description: Device authorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BurnResponse"
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/RateLimited"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/amk/wrapper:
    put:
      operationId: upsertAmkWrapper
      summary: Upsert AMK wrapper for authenticated user
      description: |
        Stores or updates a wrapped (encrypted) AMK for a specific API key.
        API key auth operates on the caller's own prefix. Session auth requires
        `key_prefix` in the request body. Returns 409 if `amk_commit` does not
        match the existing commit for the user.
      tags: [amk]
      security:
        - sessionBearer: []
        - apiKey: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpsertAmkWrapperRequest"
      responses:
        "200":
          description: Wrapper upserted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BurnResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          description: AMK commit mismatch
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalError"
    get:
      operationId: getAmkWrapper
      summary: Get AMK wrapper for a key
      description: |
        Returns the wrapped AMK for a specific API key. API key auth returns
        own wrapper. Session auth requires `?key_prefix=X`.
      tags: [amk]
      security:
        - sessionBearer: []
        - apiKey: []
        - bearerAuth: []
      parameters:
        - name: key_prefix
          in: query
          required: false
          description: API key prefix (required for session auth)
          schema:
            type: string
      responses:
        "200":
          description: Wrapped AMK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GetAmkWrapperResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/amk/wrappers:
    get:
      operationId: listAmkWrappers
      summary: List all AMK wrappers for user
      description: |
        Returns all AMK wrappers for the session-authenticated user.
        Session auth only.
      tags: [amk]
      security:
        - sessionBearer: []
      responses:
        "200":
          description: AMK wrappers list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListAmkWrappersResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/amk/exists:
    get:
      operationId: checkAmkExists
      summary: Check if user has any AMK wrapper
      description: |
        Returns whether the authenticated user has at least one AMK wrapper stored.
      tags: [amk]
      security:
        - sessionBearer: []
        - apiKey: []
        - bearerAuth: []
      responses:
        "200":
          description: AMK existence check
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AmkExistsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/secrets/{id}/meta:
    put:
      operationId: attachEncryptedNote
      summary: Attach encrypted note to a secret
      description: |
        Stores client-encrypted note metadata on a secret owned by the caller.
        The note is encrypted with a key derived from the AMK and stored as
        opaque ciphertext. Requires authentication and secret ownership.
      tags: [secrets]
      security:
        - sessionBearer: []
        - apiKey: []
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/secretId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AttachEncMetaRequest"
      responses:
        "200":
          description: Note attached
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BurnResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/apikeys/register:
    post:
      operationId: registerApiKey
      summary: Register a v2 API key auth token
      description: |
        Requires passkey session auth.
        Enforces account/IP registration quotas.
      tags: [apikeys]
      security:
        - sessionBearer: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterApiKeyRequest"
      responses:
        "201":
          description: API key registration accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegisterApiKeyResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/RateLimited"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/apikeys:
    get:
      operationId: listApiKeys
      summary: List API keys for current session user
      tags: [apikeys]
      security:
        - sessionBearer: []
      responses:
        "200":
          description: API keys for current user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListApiKeysResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/apikeys/{prefix}/revoke:
    post:
      operationId: revokeApiKey
      summary: Revoke one API key
      tags: [apikeys]
      security:
        - sessionBearer: []
      parameters:
        - $ref: "#/components/parameters/apiKeyPrefix"
      responses:
        "200":
          description: API key revoked
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BurnResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/v1/auth/account:
    delete:
      operationId: deleteAccount
      summary: Delete account and owned resources
      description: |
        Deletes the current session-authenticated user account.
        Burns owned secrets, revokes all user API keys, then deletes the user.
      tags: [auth]
      security:
        - sessionBearer: []
      responses:
        "200":
          description: Account deleted and cleanup completed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteAccountResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

components:
  securitySchemes:
    apiKey:
      type: apiKey
      in: header
      name: X-API-Key
      description: "Wire API key format: ak2_<prefix>.<auth_b64>"
    bearerAuth:
      type: http
      scheme: bearer
      description: "Wire API key bearer format: ak2_<prefix>.<auth_b64>"
    sessionBearer:
      type: http
      scheme: bearer
      description: "Passkey session bearer format: uss_<sid>.<secret>"

  parameters:
    secretId:
      name: id
      in: path
      required: true
      description: URL-safe base64-encoded secret identifier (server-generated)
      schema:
        type: string
    apiKeyPrefix:
      name: prefix
      in: path
      required: true
      description: API key prefix
      schema:
        type: string

  headers:
    X-Request-Id:
      description: Unique request identifier for tracing (auto-generated if not provided by client)
      schema:
        type: string

  schemas:
    CreateSecretRequest:
      type: object
      required:
        - envelope
        - claim_hash
      additionalProperties: false
      properties:
        envelope:
          type: object
          description: |
            Opaque JSON object produced by the client containing ciphertext,
            nonce, and KDF/HKDF parameters. Advisory metadata is encrypted in
            the sealed payload frame and is not present as plaintext fields in
            envelope JSON. The server stores and returns this unchanged.

            Max size depends on policy tier (256 KB public, 1 MB authenticated by default).
        claim_hash:
          type: string
          description: |
            Server-stored verifier for one-time claim authorization.
            Format: `base64url(sha256(claim_token_bytes))`.
            The raw claim token bytes must be at least 16 bytes.
        ttl_seconds:
          type: integer
          format: int64
          minimum: 1
          maximum: 31536000
          description: |
            Secret lifetime in seconds. Default: 86400 (24 hours).
            Maximum: 31536000 (1 year). Omit to use the default.

    CreateSecretResponse:
      type: object
      properties:
        id:
          type: string
          description: URL-safe base64-encoded secret identifier
        share_url:
          type: string
          format: uri
          description: Full URL for sharing (e.g. `https://secrt.ca/s/<id>`)
        expires_at:
          type: string
          format: date-time
          description: Expiration timestamp (RFC 3339, UTC)

    SecretMetadataItem:
      type: object
      required: [id, share_url, expires_at, created_at, ciphertext_size, passphrase_protected]
      properties:
        id:
          type: string
        share_url:
          type: string
          format: uri
        expires_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        ciphertext_size:
          type: integer
          format: int64
        passphrase_protected:
          type: boolean
        enc_meta:
          $ref: "#/components/schemas/EncMetaV1"

    ListSecretsResponse:
      type: object
      required: [secrets, total, limit, offset]
      properties:
        secrets:
          type: array
          items:
            $ref: "#/components/schemas/SecretMetadataItem"
        total:
          type: integer
          format: int64
        limit:
          type: integer
          format: int64
        offset:
          type: integer
          format: int64

    SecretsCheckResponse:
      type: object
      required: [count, checksum]
      properties:
        count:
          type: integer
          format: int64
        checksum:
          type: string
          description: Opaque change-detection value for currently visible active secrets

    ClaimSecretRequest:
      type: object
      required:
        - claim
      additionalProperties: false
      properties:
        claim:
          type: string
          description: |
            Base64url-encoded claim token bytes. The server hashes this
            (`sha256`) and compares against the stored `claim_hash`.

    ClaimSecretResponse:
      type: object
      properties:
        envelope:
          type: object
          description: The original opaque envelope stored at creation time
        expires_at:
          type: string
          format: date-time
          description: Original expiration timestamp (RFC 3339, UTC)

    BurnResponse:
      type: object
      properties:
        ok:
          type: boolean
          description: Always `true` on success

    ApiKeyListItem:
      type: object
      required: [prefix, scopes, created_at]
      properties:
        prefix:
          type: string
        scopes:
          type: string
        created_at:
          type: string
          format: date-time
        revoked_at:
          type: string
          format: date-time
          nullable: true

    ListApiKeysResponse:
      type: object
      required: [api_keys]
      properties:
        api_keys:
          type: array
          items:
            $ref: "#/components/schemas/ApiKeyListItem"

    DeleteAccountResponse:
      type: object
      required: [ok, secrets_burned, keys_revoked]
      properties:
        ok:
          type: boolean
        secrets_burned:
          type: integer
          format: int64
        keys_revoked:
          type: integer
          format: int64

    EncMetaV1:
      type: object
      nullable: true
      description: Client-encrypted note metadata. Null or absent when no note is attached.
      required: [v, note]
      properties:
        v:
          type: integer
          description: Schema version, must be 1
          enum: [1]
        note:
          type: object
          required: [ct, nonce, salt]
          properties:
            ct:
              type: string
              description: base64url-encoded AES-256-GCM ciphertext of the note text
            nonce:
              type: string
              description: base64url-encoded 12-byte GCM nonce
            salt:
              type: string
              description: base64url-encoded HKDF salt for per-note key derivation

    AmkTransfer:
      type: object
      nullable: true
      description: Encrypted AMK transfer payload for device authorization. Present only when the approver has an AMK and the CLI advertised an ECDH public key.
      required: [ct, nonce, ecdh_public_key]
      properties:
        ct:
          type: string
          description: base64url-encoded ciphertext of the AMK encrypted with the ECDH shared secret
        nonce:
          type: string
          description: base64url-encoded 12-byte nonce
        ecdh_public_key:
          type: string
          description: base64url-encoded P-256 ECDH public key of the approver

    UpsertAmkWrapperRequest:
      type: object
      required: [wrapped_amk, nonce, amk_commit, version]
      additionalProperties: false
      properties:
        key_prefix:
          type: string
          description: API key prefix (required for session auth, optional for API key auth)
        wrapped_amk:
          type: string
          description: base64url-encoded wrapped AMK ciphertext
        nonce:
          type: string
          description: base64url-encoded 12-byte nonce
        amk_commit:
          type: string
          description: base64url-encoded commitment hash binding the AMK identity
        version:
          type: integer
          description: AMK version number

    GetAmkWrapperResponse:
      type: object
      required: [user_id, wrapped_amk, nonce, version]
      properties:
        user_id:
          type: string
          format: uuid
        wrapped_amk:
          type: string
          description: base64url-encoded wrapped AMK ciphertext
        nonce:
          type: string
          description: base64url-encoded nonce
        version:
          type: integer

    ListAmkWrappersResponse:
      type: object
      required: [wrappers]
      properties:
        wrappers:
          type: array
          items:
            type: object
            required: [key_prefix, version, created_at]
            properties:
              key_prefix:
                type: string
              version:
                type: integer
              created_at:
                type: string
                format: date-time

    AmkExistsResponse:
      type: object
      required: [exists]
      properties:
        exists:
          type: boolean
          description: Whether the user has at least one AMK wrapper

    AttachEncMetaRequest:
      type: object
      required: [enc_meta, meta_key_version]
      additionalProperties: false
      properties:
        enc_meta:
          $ref: "#/components/schemas/EncMetaV1"
        meta_key_version:
          type: integer
          description: AMK version that encrypted this note

    DeviceChallengeResponse:
      type: object
      required: [user_code, status]
      properties:
        user_code:
          type: string
          description: User code for the pending challenge (format XXXX-XXXX)
        ecdh_public_key:
          type: string
          nullable: true
          description: base64url-encoded P-256 ECDH public key from the CLI (null if not provided)
        status:
          type: string
          description: Challenge status
          enum: [pending]

    PasskeyRegisterStartRequest:
      type: object
      required: [display_name]
      additionalProperties: false
      properties:
        display_name:
          type: string

    PasskeyRegisterFinishRequest:
      type: object
      required: [challenge_id, credential_id, public_key]
      additionalProperties: false
      properties:
        challenge_id:
          type: string
          description: Opaque challenge identifier issued by register/start
        credential_id:
          type: string
        public_key:
          type: string

    PasskeyLoginStartRequest:
      type: object
      required: [credential_id]
      additionalProperties: false
      properties:
        credential_id:
          type: string

    PasskeyLoginFinishRequest:
      type: object
      required: [challenge_id, credential_id]
      additionalProperties: false
      properties:
        challenge_id:
          type: string
          description: Opaque challenge identifier issued by login/start
        credential_id:
          type: string

    PasskeyStartResponse:
      type: object
      properties:
        challenge_id:
          type: string
          description: Opaque bearer challenge identifier consumed by /finish
        challenge:
          type: string
          description: Opaque challenge payload for client flow coordination
        expires_at:
          type: string
          format: date-time

    AuthFinishResponse:
      type: object
      properties:
        session_token:
          type: string
        display_name:
          type: string
        expires_at:
          type: string
          format: date-time

    SessionResponse:
      type: object
      properties:
        authenticated:
          type: boolean
        display_name:
          type: string
          nullable: true
        expires_at:
          type: string
          format: date-time
          nullable: true

    DeviceStartRequest:
      type: object
      required: [auth_token]
      additionalProperties: false
      properties:
        auth_token:
          type: string
          description: base64url-encoded 32-byte auth token derived from CLI-generated root key
        ecdh_public_key:
          type: string
          description: Optional base64url-encoded P-256 ECDH public key for AMK transfer

    DeviceStartResponse:
      type: object
      required: [device_code, user_code, verification_url, expires_in, interval]
      properties:
        device_code:
          type: string
          description: Opaque identifier for polling (base64url-encoded 32 random bytes)
        user_code:
          type: string
          description: Human-readable code for browser verification (format XXXX-XXXX)
          example: "ABCD-1234"
        verification_url:
          type: string
          format: uri
          description: URL to open in browser for approval
          example: "https://secrt.ca/device?code=ABCD-1234"
        expires_in:
          type: integer
          description: Challenge lifetime in seconds (600 = 10 minutes)
        interval:
          type: integer
          description: Recommended polling interval in seconds

    DevicePollRequest:
      type: object
      required: [device_code]
      additionalProperties: false
      properties:
        device_code:
          type: string
          description: Device code returned by /device/start

    DevicePollResponse:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [authorization_pending, complete]
          description: |
            `authorization_pending` while waiting for browser approval.
            `complete` when the device has been authorized.
        prefix:
          type: string
          description: API key prefix (present only when status is `complete`)
        amk_transfer:
          $ref: "#/components/schemas/AmkTransfer"

    DeviceApproveRequest:
      type: object
      required: [user_code]
      additionalProperties: false
      properties:
        user_code:
          type: string
          description: User code displayed in the CLI terminal (format XXXX-XXXX)
        amk_transfer:
          $ref: "#/components/schemas/AmkTransfer"

    RegisterApiKeyRequest:
      type: object
      required: [auth_token]
      additionalProperties: false
      properties:
        auth_token:
          type: string
          description: base64url-encoded 32-byte auth token
        scopes:
          type: string

    RegisterApiKeyResponse:
      type: object
      properties:
        prefix:
          type: string
        created_at:
          type: string
          format: date-time

    HealthResponse:
      type: object
      properties:
        ok:
          type: boolean
        time:
          type: string
          format: date-time
          description: Server time (RFC 3339 with nanoseconds, UTC)

    InfoResponse:
      type: object
      properties:
        authenticated:
          type: boolean
          description: Whether a valid API key was provided
        features:
          type: object
          properties:
            encrypted_notes:
              type: boolean
              description: Whether the server supports encrypted notes (enc_meta)
        ttl:
          type: object
          properties:
            default_seconds:
              type: integer
              format: int64
              description: Default TTL when ttl_seconds is omitted (86400 = 24h)
            max_seconds:
              type: integer
              format: int64
              description: Maximum allowed TTL (31536000 = 1 year)
        limits:
          type: object
          properties:
            public:
              $ref: "#/components/schemas/InfoTier"
            authed:
              $ref: "#/components/schemas/InfoTier"
        claim_rate:
          $ref: "#/components/schemas/InfoRate"

    InfoTier:
      type: object
      properties:
        max_envelope_bytes:
          type: integer
          format: int64
        max_secrets:
          type: integer
          format: int64
        max_total_bytes:
          type: integer
          format: int64
        rate:
          $ref: "#/components/schemas/InfoRate"

    InfoRate:
      type: object
      properties:
        requests_per_second:
          type: number
          format: double
        burst:
          type: integer

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Human-readable error message

  responses:
    BadRequest:
      description: Invalid request (malformed JSON, missing fields, invalid envelope, etc.)
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            invalidJson:
              value:
                error: "invalid json"
            invalidEnvelope:
              value:
                error: "invalid envelope"
            envelopeTooLarge:
              value:
                error: "envelope exceeds maximum size (256 KB)"
            invalidClaimHash:
              value:
                error: "invalid claim_hash"
            invalidTTL:
              value:
                error: "invalid ttl_seconds"
      headers:
        X-Request-Id:
          $ref: "#/components/headers/X-Request-Id"

    Unauthorized:
      description: Missing or invalid API key or session token
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "unauthorized"
      headers:
        X-Request-Id:
          $ref: "#/components/headers/X-Request-Id"

    NotFound:
      description: Secret not found, expired, already claimed, wrong claim token, or not owned by caller
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "not found"
      headers:
        X-Request-Id:
          $ref: "#/components/headers/X-Request-Id"

    RateLimited:
      description: Request rate limited or active-secret count quota exceeded
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            rateLimited:
              value:
                error: "rate limit exceeded; please try again in a few seconds"
            secretLimitExceeded:
              value:
                error: "secret limit exceeded (max 10 active secrets)"
      headers:
        X-Request-Id:
          $ref: "#/components/headers/X-Request-Id"

    StorageQuotaExceeded:
      description: Total storage quota exceeded for the owner
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "storage quota exceeded (limit 2 MB)"
      headers:
        X-Request-Id:
          $ref: "#/components/headers/X-Request-Id"

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: "internal server error"
      headers:
        X-Request-Id:
          $ref: "#/components/headers/X-Request-Id"

tags:
  - name: health
    description: Health check endpoint
  - name: info
    description: Server info and operational limits
  - name: secrets
    description: One-time secret creation, claim, burn, and encrypted note operations
  - name: auth
    description: Passkey registration/login, device authorization, and browser session management
  - name: amk
    description: Account Master Key wrapper management
  - name: apikeys
    description: API key registration, listing, and revocation endpoints
